<!doctype html>
<!--
* Tabler - Premium and Open Source dashboard template with responsive and high quality UI.
* @version 1.0.0-alpha.7
* @link https://github.com/tabler/tabler
* Copyright 2018-2019 The Tabler Authors
* Copyright 2018-2019 codecalm.net Paweł Kuna
* Licensed under MIT (https://tabler.io/license)
-->
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Template</title>
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
  <meta name="msapplication-TileColor" content="#206bc4" />
  <meta name="theme-color" content="#206bc4" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="robots" content="noindex,nofollow,noarchive" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />
  <!-- CSS files -->
  <link href="/static/dist/libs/jqvmap/dist/jqvmap.min.css" rel="stylesheet" />
  <link href="/static/dist/libs/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link href="/static/dist/css/tabler.min.css" rel="stylesheet" />
  <link href="/static/dist/css/demo.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    body {
      display: none;
    }
  </style>
</head>

<body class="antialiased">
  <div class="page">

    <header class="navbar navbar-expand-md navbar-light">
      <div class="container-xl">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu">
          <span class="navbar-toggler-icon"></span>
        </button>
        <a href="." class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pr-0 pr-md-3">
          <img src="../static/logo.png" alt="Tabler" class="navbar-brand-image">
        </a>
        <div class="navbar-nav flex-row order-md-last">
          <!-- <div class="nav-item dropdown d-none d-md-flex mr-3">
              <a href="#" class="nav-link px-0" data-toggle="dropdown" tabindex="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 5a2 2 0 0 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6" /><path d="M9 17v1a3 3 0 0 0 6 0v-1" /></svg>
                <span class="badge bg-red"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-right dropdown-menu-card">
                <div class="card">
                  <div class="card-body">
                    Lorem ipsum dolor sit amet, consectetur adipisicing elit. Accusamus ad amet consectetur exercitationem fugiat in ipsa ipsum, natus odio quidem quod repudiandae sapiente. Amet debitis et magni maxime necessitatibus ullam.
                  </div>
                </div>
              </div>
            </div> -->
          <div class="nav-item dropdown">
            <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-toggle="dropdown">
              {% set avatar_url = url_for('static', filename='uploads/' ~ user.photo) if user and user.photo else
              url_for('static', filename='avatars/005f.jpg') %}
              <span class="avatar" style="background-image: url('{{ avatar_url }}')"></span>
              <div class="d-none d-xl-block pl-2">
                <div>{{ username }}</div>
                <div class="mt-1 small text-muted">{{ role }}</div>
              </div>
            </a>
            <div class="dropdown-menu dropdown-menu-right">
              <a class="dropdown-item" href="{{ url_for('profile') }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-item-icon" width="24" height="24"
                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                  <path d="M5.5 21v-2a4 4 0 0 1 4 -4h5a4 4 0 0 1 4 4v2"></path>
                </svg>
                Profile
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="{{ url_for('logout') }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon dropdown-item-icon" width="24" height="24"
                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z"></path>
                  <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2"></path>
                  <path d="M7 12h14l-3 -3m0 6l3 -3"></path>
                </svg>
                Logout
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="navbar-expand-md">
      <div class="collapse navbar-collapse" id="navbar-menu">
        <div class="navbar navbar-light">
          <div class="container-xl">
            <ul class="navbar-nav">
              <li class="nav-item active">
                <a class="nav-link" href="{{ url_for('pegawai_dashboard') }}">
                  <span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg"
                      class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
                      fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" />
                      <polyline points="5 12 3 12 12 3 21 12 19 12" />
                      <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
                      <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
                    </svg>
                  </span>
                  <span class="nav-link-title">
                    Dashboard
                  </span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('pegawai_absensi') }}">
                  <span class="nav-link-icon d-md-none d-lg-inline-block">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                      <path d="M5.5 21v-2a4 4 0 0 1 4 -4h5a4 4 0 0 1 4 4v2"></path>
                    </svg>
                  </span>
                  <span class="nav-link-title">
                    Absensi
                  </span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('pegawai_lamakerja') }}">
                  <span class="nav-link-icon d-md-none d-lg-inline-block">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                      <path d="M5.5 21v-2a4 4 0 0 1 4 -4h5a4 4 0 0 1 4 4v2"></path>
                    </svg>
                  </span>
                  <span class="nav-link-title">
                    Lama Kerja
                  </span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('upload_photo') }}">
                  <span class="nav-link-icon d-md-none d-lg-inline-block">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                      <path d="M7 9l5 -5l5 5" />
                      <path d="M12 4v12" />
                    </svg>
                  </span>
                  <span class="nav-link-title">
                    Upload Pegawai
                  </span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>


    <div class="content">
      <div class="container-xl">
        <!-- Page title -->
        <div class="page-header">
          <div class="row align-items-center">
            <div class="col-auto">
              <!-- Page pre-title -->
              <div class="page-pretitle">
                Overview
              </div>
              <h2 class="page-title">
                Dashboard
              </h2>
            </div>
          </div>
        </div>
        <div class="row row-deck row-cards">

          <div class="col-sm-5">
            <div class="card">
              <div class="card-header border-0">
                <h3 class="card-title">Stats Pegawai Bulan Ini</h3>
              </div>
              <div class="card-body">
                <div id="chart-donut" style="height: 240px;"></div>

              </div>
            </div>
          </div>

          <div class="col-sm-7">
            <div class="row row-deck row-cards">
              <div class="col-sm-6">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="subheader">Total Tepat waktu</div>
                    </div>
                    <div class="h1 mb-1 mt-3" id="total-tepat-waktu">0</div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="subheader">Total Terlambat</div>
                    </div>
                    <div class="h1 mb-1 mt-3" id="total-terlambat">0</div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="subheader">Total Kehadiran</div>
                    </div>
                    <div class="h1 mb-1 mt-3" id="total-kehadiran">0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card">
              <div class="card-header border-0">
                <h3 class="card-title">Riwayat Absensi Hari Ini</h3>
              </div>
              <div class="card-body">
                <div class="d-flex mb-3">
                  <div class="table-responsive w-100">
                    <table class="table card-table table-vcenter text-nowrap datatable">
                      <thead>
                        <tr>
                          <th class="w-1">
                            No.
                          </th>
                          <th>Tanggal</th>
                          <th>Nama pegawai</th>
                          <th>Divisi</th>
                          <th>Presensi Datang</th>
                        </tr>
                      </thead>
                      <tbody id="riwayat-absensi-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
         <footer class="footer footer-transparent">
          <div class="container">
            <div class="row text-center align-items-center flex-row-reverse">
              <div class="col-lg-auto ml-lg-auto">
                <ul class="list-inline list-inline-dots mb-0">
                  All rights reserved.
                </ul>
              </div>
              <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                Copyright ©absensidanmonitoring 2025
              </div>
            </div>
          </div>
        </footer>
    </div>
  </div>

  <!-- Libs JS -->
  <script src="../static/dist/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../static/dist/libs/jquery/dist/jquery.slim.min.js"></script>
  <script src="../static/dist/libs/peity/jquery.peity.min.js"></script>
  <script src="../static/dist/libs/apexcharts/dist/apexcharts.min.js"></script>
  <script src="../static/dist/libs/flatpickr/dist/flatpickr.min.js"></script>
  <!-- Tabler Core -->
  <script src="../static/dist/js/tabler.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      flatpickr(document.getElementById('calendar-range'), {
        mode: "range"
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      fetch('/chart-donat', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          console.log("[DATA DARI BACKEND]", data);

          document.getElementById("total-tepat-waktu").innerText = data.ontime;
          document.getElementById("total-terlambat").innerText = data.late;
          document.getElementById("total-kehadiran").innerText = data.total_absen;


          const el = document.querySelector("#chart-donut");
          if (!el) {
            console.error("❌ chart-donut tidak ditemukan di DOM");
            return;
          }

          let seriesData = [data.ontime, data.late, data.total_absen];
          let labels = ["Tepat Waktu", "Terlambat", "Total Kehadiran"];
          let colors = ["#28a745", "#ffc107", "#007bff"];

          // Fallback jika semua nilai 0
          const total = seriesData.reduce((a, b) => a + b, 0);
          if (total === 0) {
            seriesData = [1];
            labels = ["Belum Ada Data"];
            colors = ["#dee2e6"];
          }

          const options = {
            chart: {
              type: "donut",
              height: 240
            },
            series: seriesData,
            labels: labels,
            colors: colors,
            legend: {
              show: true,
              position: 'bottom'
            },
            tooltip: {
              y: {
                formatter: function (val) {
                  return `${val} `;
                }
              }
            },
            dataLabels: {
              formatter: function (val, opts) {
                // Ambil nilai mentah dari series
                const index = opts.seriesIndex;
                const value = opts.w.config.series[index];
                return `${value} `;
              }
            }
          };


          new ApexCharts(el, options).render();
        })
        .catch(err => {
          console.error("Gagal ambil data:", err);
        });
    });
  </script>

  <script>
    document.body.style.display = "block"
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      fetch('/riwayat-hari-ini')
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById("riwayat-absensi-body");
          tbody.innerHTML = "";

          data.forEach((row, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${row.tanggal}</td>
          <td>${row.nama_pegawai}</td>
          <td>${row.divisi}</td>
          <td>${row.presensi_datang}</td>
        `;
            tbody.appendChild(tr);
          });
        })
        .catch(err => {
          console.error("Gagal mengambil data riwayat hari ini:", err);
        });
    });
  </script>

</body>

</html>